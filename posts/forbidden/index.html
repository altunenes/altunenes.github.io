<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Why Shaders Turn Black: negatives in pow() and sqrt()
        
    </title><meta content="Why Shaders Turn Black: negatives in pow() and sqrt()" property=og:title><meta content="personal blog" property=og:description><meta content="personal blog" name=description><link href=/icon/favicon.png rel=icon type=image/png><link href=https://altunenes.github.io/fonts.css rel=stylesheet><link href=https://altunenes.github.io/atom.xml rel=alternate title=altunenes type=application/atom+xml><link href=https://altunenes.github.io/theme/light.css rel=stylesheet><link href=https://altunenes.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://altunenes.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://altunenes.github.io/main.css media=screen rel=stylesheet><script data-cf-beacon='{"token": "37a0f981a37240aea00b781e300bc6c0"}' defer src=https://static.cloudflareinsights.com/beacon.min.js></script></head><script>// Function to set the theme
        function setTheme(theme) {
            document.documentElement.className = theme;
            localStorage.setItem('theme', theme);
        }

        // Function to get the saved theme
        function getSavedTheme() {
            return localStorage.getItem('theme') || 'light';
        }

        // Set the theme on page load
        document.addEventListener('DOMContentLoaded', (event) => {
            setTheme(getSavedTheme());
        });</script><body><div class=content><header><div class=main><a href=https://altunenes.github.io/>altunenes</a><div class=socials><a class=social href=https://twitter.com/emportent rel=me> <img alt=x src=https://altunenes.github.io/social_icons/x.svg> </a><a class=social href=https://github.com/altunenes rel=me> <img alt=github src=https://altunenes.github.io/social_icons/github.svg> </a><a href="https://scholar.google.com/citations?user=_OtEw5oAAAAJ&hl" class=social rel=me> <img alt=scholar src=https://altunenes.github.io/social_icons/googlescholar.svg> </a><a class=social href=https://www.linkedin.com/in/enes-altun-0a3076167 rel=me> <img alt=linkedin src=https://altunenes.github.io/social_icons/linkedin.svg> </a><a class=social href=https://www.instagram.com/altunanes/ rel=me> <img alt=instagram src=https://altunenes.github.io/social_icons/instagram.svg> </a><a class=social href=https://orcid.org/0000-0002-6478-6909 rel=me> <img alt=orcid src=https://altunenes.github.io/social_icons/orcid.svg> </a><a class=social href=https://www.shadertoy.com/user/altunenes rel=me> <img alt=shadertoy src=https://altunenes.github.io/social_icons/shadertoy.svg> </a><a class=social href=https://bsky.app/profile/altunenes.bsky.social rel=me> <img alt=bluesky src=https://altunenes.github.io/social_icons/bluesky.svg> </a></div></div><nav><a href=https://altunenes.github.io/posts style=margin-left:.7em>/posts</a><a href=https://altunenes.github.io/projects style=margin-left:.7em>/projects</a><a href=https://altunenes.github.io/about style=margin-left:.7em>/about</a><a href=https://altunenes.github.io/tags style=margin-left:.7em>/tags</a><a href=https://altunenes.github.io/CV style=margin-left:.7em>/CV</a><button aria-label="Toggle dark mode" id=dark-mode-toggle onclick=toggleTheme();><img alt="Light mode" id=sun-icon src=https://altunenes.github.io/feather/sun.svg> <img alt="Dark mode" id=moon-icon src=https://altunenes.github.io/feather/moon.svg></button></nav></header><script>function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    
    html.classList.remove(currentTheme);
    html.classList.add(newTheme);
    
    localStorage.setItem('theme', newTheme);
    updateThemeToggleIcons();
}

function updateThemeToggleIcons() {
    const sunIcon = document.getElementById('sun-icon');
    const moonIcon = document.getElementById('moon-icon');
    const isDarkMode = document.documentElement.classList.contains('dark');
    
    sunIcon.style.display = isDarkMode ? 'none' : 'inline';
    moonIcon.style.display = isDarkMode ? 'inline' : 'none';
}

// Set initial theme
const savedTheme = localStorage.getItem('theme') || 'light';
document.documentElement.classList.add(savedTheme);
updateThemeToggleIcons();</script><main><article><div class=title><div class=page-header>Why Shaders Turn Black: negatives in pow() and sqrt()<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2025-08-13</time></div></div><h1>Table of Contents</h1><ul><li><a href=https://altunenes.github.io/posts/forbidden/#why-shaders-turn-black-negatives-in-pow-and-sqrt>Why Shaders Turn Black: negatives in pow() and sqrt()</a> <ul><li><a href=https://altunenes.github.io/posts/forbidden/#visualizing-the-error-and-the-fix>Visualizing the Error and the Fix</a><li><a href=https://altunenes.github.io/posts/forbidden/#the-technical-reality-behind-the-error>The Technical Reality Behind the Error</a><li><a href=https://altunenes.github.io/posts/forbidden/#references>References</a></ul></ul><section class=body><h2 id=why-shaders-turn-black-negatives-in-pow-and-sqrt><span style=color:orange>Why Shaders Turn Black: negatives in pow() and sqrt()</span></h2><p>Black pixels appearing in a shader often trace back to a mathematical domain error. The most common sources are the <code>sqrt()</code> and <code>pow()</code> functions when they receive invalid inputs.<p>In GLSL, <code>sqrt(x)</code> is undefined if <code>x</code> is negative. Similarly, <code>pow(x, y)</code> is undefined if <code>x</code> is negative and <code>y</code> is not an integer. When asked to perform an undefined operation, most GPUs return <code>NaN</code> (Not a Number). Any further math involving this <code>NaN</code> also results in <code>NaN</code>, and the renderer typically draws these pixels as black. To make matters worse, compilers often won't warn you about this potential problem, making the bug difficult to trace in a complex shader.<h3 id=visualizing-the-error-and-the-fix>Visualizing the Error and the Fix</h3><p>The following demos show the problem in action. The left side (red) performs the math naively. The right side (green) uses <code>abs()</code> to prevent errors.<p><strong>1. The <code>sqrt()</code> Domain Error</strong><p>Graphing <code>y = sqrt(sin(x))</code>. The gaps on the left show where <code>sin(x)</code> is negative and the math fails.<div align=center><iframe src="https://www.shadertoy.com/embed/W3yXWc?gui=true&t=10&paused=true&muted=false" allowfullscreen frameborder=0 height=360 width=640></iframe></div><p><strong>2. The <code>pow()</code> Domain Error</strong><p>Graphing <code>y = pow(sin(x), 2.5)</code>. The same issue occurs, breaking the function where the base is negative.<div align=center><iframe src="https://www.shadertoy.com/embed/33GSDc?gui=true&t=10&paused=true&muted=false" allowfullscreen frameborder=0 height=360 width=640></iframe></div><br> *<small>Note: If a shader appears broken, try refreshing the page as Shadertoy can sometimes be unstable.</small>* <p>This variance across platforms, which can depend on the GPU hardware or its drivers, is a key reason to handle these edge cases proactively with <code>abs()</code> or other methods, as the output is not guaranteed. For example, while most desktop GPUs produce clean gaps, some GPUs (like on an iPhone 6s in the example below) handle the error differently. Notice how the <code>sqrt()</code> error is avoided entirely, but the <code>pow()</code> error still renders artifacts—not as empty gaps, but this time as large black columns!<div align=center style=flex-wrap:wrap;justify-content:center;gap:10px;display:flex><img alt="iPhone 6s screenshot of sqrt shader without gaps" src=/images/iphone6s_1.jpg width=48%><img alt="iPhone 6s screenshot of pow shader with black columns" src=/images/iphone6s_2.jpg width=48%></div><center> *<small>Screenshot from an iPhone 6s: in contrast to modern desktop GPUs, this older mobile hardware appears to fill the gaps in the `sqrt` example, yet produces distinct vertical artifacts for the `pow` function.</small>* </center><h3 id=the-technical-reality-behind-the-error>The Technical Reality Behind the Error</h3><p>Using <code>abs()</code> fixes the black pixels, but it's crucial to understand <em>why</em> the failure occurs to write better code.<p>GPUs don't calculate powers through repeated multiplication. For performance, they use the mathematical identity: <strong><code>pow(x, y) = exp2(y * log2(x))</code></strong>(see ref). The failure point is <code>log2(x)</code>. The logarithm of a negative number is undefined in the real number system. Therefore, any negative <code>x</code> passed to <code>pow()</code> causes the internal calculation to fail and produce a <code>NaN</code>.<p>While <code>abs()</code> prevents <code>NaN</code>s, it can introduce silent mathematical bugs. Consider <code>(-2)³</code>, which should be <code>-8</code>.<ul><li><code>pow(-2.0, 3.0)</code> might fail due to the <code>log/exp</code> implementation.<li><code>pow(abs(-2.0), 3.0)</code> will incorrectly return <code>8</code>.</ul><p>This error can invert lighting or break procedural patterns. When you need to preserve the sign for odd integer powers, the correct pattern is:<pre class=giallo style=color:#bfbdb6;background-color:#0d1017><code data-lang=glsl><span class=giallo-l><span style=color:#ff8f40>float</span><span> result </span><span style=color:#f29668>=</span><span style=color:#f07178> pow</span><span>(</span><span style=color:#ffb454>abs</span><span>(x)</span><span style=color:#bfbdb6b3>,</span><span> y)</span><span style=color:#f29668> *</span><span style=color:#f07178> sign</span><span>(x)</span><span style=color:#bfbdb6b3>;</span></span></code></pre><p>A conditional check like <code>if (x >= 0.0)</code> might seem safe, but it's a performance trap. Branches cause 'thread divergence' on GPUs, hurting the parallelism that makes them fast. Branchless functions like <code>abs()</code>, <code>max()</code>, and <code>sign()</code> are far more efficient (see: <a href=https://theorangeduck.com/page/avoiding-shader-conditionals rel=external>theorangeduck</a>, See: <a href=https://gpuopen.com/download/GDC2017-Advanced-Shader-Programming-On-GCN.pdf rel=external>3</a>). Writing robust shader code means handling these cases smartly. For integer powers, explicit multiplication like <code>x*x</code> is always better than <code>pow(x, 2.0)</code> [1,2]. It's faster and avoids the log/exp path entirely. To prevent floating-point errors from creating negative inputs later, proactively clamp values with <code>max(value, 0.0)</code> or <code>saturate(value)</code>, especially after operations like <code>dot()</code>. Finally, use <code>abs()</code> with care. It's a tool for getting a magnitude, not a universal patch. If you need to preserve a negative sign with an odd power, the <code>sign(x) * pow(abs(x), y)</code> pattern is the mathematically correct approach.<h3 id=references>References</h3><p>[1] <a href=https://community.khronos.org/t/pow-x-2-different-then-x-x/70839/3 rel=external>Khronos Forums Discussion: "Pow(x, 2) different then x*x?"</a><p>[2] <a href=https://gpuopen.com/learn/amd-lab-notes/amd-lab-notes-register-pressure-readme/ rel=external>Register pressure in AMD CDNA2™ GPUs</a><p>[3] <a href=https://gpuopen.com/download/GDC2017-Advanced-Shader-Programming-On-GCN.pdf rel=external>ADVANCED SHADER PROGRAMMING ON GCN</a></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=https://altunenes.github.io/tags/gpu/>GPU</a><li><a href=https://altunenes.github.io/tags/math/>math</a><li><a href=https://altunenes.github.io/tags/shaders/>shaders</a><li><a href=https://altunenes.github.io/tags/glsl/>GLSL</a></ul></nav></div><hr><div class=citation style=color:var(--text-color-secondary);margin-top:2em;font-size:.8em><p style=margin-bottom:.6em;font-size:.9em;font-weight:700>Cite:<p style=margin-bottom:.5em>Altun, E. (2025, August 13). <em>Why Shaders Turn Black: negatives in pow() and sqrt()</em>. Retrieved from <a href=https://altunenes.github.io/posts/forbidden/>https://altunenes.github.io/posts/forbidden/</a><p><small><a href=http://creativecommons.org/licenses/by/4.0/ rel=license target=_blank>CC BY 4.0</a></small></div></article></main><div class=giscus></div><script async crossorigin data-category=General data-category-id=DIC_kwDOL5Nyoc4CfU7n data-emit-metadata=0 data-input-position=bottom data-lang=en data-mapping=pathname data-reactions-enabled=1 data-repo=altunenes/altunenes.github.io data-repo-id=R_kgDOL5NyoQ data-strict=0 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div>